# EMSIM

EMSim is a library that computes different electro-magnetic effects
like LPF and VSD.

## Features

EMSim provides the following functionality:

In order to compute LFP or VSD, there are a few common initial steps:

1.Load the circuit data from a circuit file
2.Create all the static morphology geometry
3.Apply current and voltage report on the geometry
4.Finally, specific calculations are done to compute LFP or VSD


The LFP part of EMSim computes the electric field in the space between neurons.
For that, the below steps are executed:

1. Load and place all segments in 3D space
2. Load the current report for each segment and for every simulation frame
3. Create a volume with the specified resolution (# of voxels)
4. Compute the value for each voxel, using the current point model
a. As a simplification, one can also compute the values of some sample
points instead of the full volume


The VSD part of EMSim simulates the processes of a voltage sensitive dye.
For that, the below steps are executed:

1. Load and place all segments in 3D space
2. Load the voltage report for each segment and for every simulation frame
3. Create a volume with the specified resolution (# of voxels)
4. For each voxel, the value is accumulated
5. Create a projection of the volume into a 2D surface


* Compute LFP:
    TODO: describe algorithm

* Compute VSD
    TODO: describe algorithm

## Usage

Compute the LFP values on 2 probes:

    emsim                        \
        -i blueconfigFile        \
        -o outputFileName        \
        --target cuirtcuitTarget \
        --report currentReport   \
        --sample-point 12,34,32  \
        --sample-point 43,56,43  \

Compute the VSD with 1000um sensor size with a 512 resolution:

    emsimVSD                           \
        -i blueconfigFile              \
        -o outputFileName              \
        --target cuirtcuitTarget       \
        --report-voltage voltageReport \
        --report-area areaReport       \
        --sensor-dim 1000              \
        --sensor-res 512

from taylor
        'emsimVSD',
        '--start-time', str(params['start-time']),
        '--end-time', str(params['end-time']),
        '--time-step', str(params['time-step']),
        '--sigma', str(params['sigma']),
        '--g0', str(params['g0']),
        '--curve', curve,
        '--ap-threshold', str(params['ap-threshold']),
        '--v0', str(params['v0']),
        '--depth', str(params['depth']),
        '--fraction', str(params['fraction']),

        "emsim-vsd-args": {
            "target": "string, Name of the simulated circuit target",
            "report-voltage": "string, Name of the voltage report in the BlueConfig",
            "report-area": "string, Name of the area report in the BlueConfig",
            "sensor-res": int, Number of pixels per side of the square sensor,
            "sensor-dim": float, Length of side of the square sensor in micrometers,
            "curve": "string or null, path to a depth-dependent dye attenuation curve file. If null
                      then `insilico_vsdi/data/RH1691-cortical-penetration-mouse.txt` is used. This
                      file was generated by digitizing the black curve in Fig. 2L in the paper
                      https://doi.org/10.1016/j.neuron.2006.03.043."
            "start-time": float, Start time of the simulation in milliseconds,
            "end-time": float, End time of the simulation in milliseconds,
            "time-step": float, Time step between frames in milliseconds,
            "fraction": float, The fraction [0.0 1.0] of gids to be used,
            "export-volume": bool, Will export a floating point volume for each time steps.,
            "depth": float, Depth of the attenuation curve in micrometers. Applied from y=0
                    (circuit bottom) to specified height. Default: 2081.756 micrometers,
            "interpolate-attenuation": bool, Will interpolate the attenuation curve,
            "sigma": float, Effective modified Beer-Lambert law extinction coefficient (inverse of
                    mean photon path length between scattering events, inverse meters). Must be a
                    positive value (default: 0.0015),
            "v0": float, Mean resting potential (default: -65 mV),
            "g0": float, Autofluorescence and noise calibration scale factor
                  (default: 250, unit-less),
            "ap-threshold": float, Membrane potential value above which to threshold compartment
                    voltage signals. Useful for excluding spiking activity from analysis.
                    Default: 3.40282347e+38 (effectively infinite, thus no thresholding applied),
            "soma-pixels": bool, Produce a text file containing the GIDs loaded and their
                  corresponding 3D positions and indices in the resulting 2D image
        },

## Output Format
    TODO: describe the output formats

# Soma position and corresponding pixel index for each cell, in the following format:
#     gid [ posX posY posZ ]: i j

## Acknowledgement & Funding

This project was supported by funding to the Blue Brain Project, a research
center of the École polytechnique fédérale de Lausanne (EPFL), from the Swiss
government's ETH Board of the Swiss Federal Institutes of Technology.

Copyright (c) 2017-2021 Blue Brain Project/EPFL
